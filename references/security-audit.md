# 安全审计清单

## 审查输出格式

审查结果按严重程度分级输出：

| 等级 | 标记 | 说明 | 处理要求 |
|------|------|------|----------|
| 严重 | 🔴 | 可被直接利用的漏洞 | 必须立即修复 |
| 警告 | 🟠 | 潜在风险，特定条件可利用 | 应尽快修复 |
| 建议 | 🟡 | 不规范但暂无直接风险 | 计划修复 |
| 优化 | 🔵 | 可改进的安全实践 | 酌情处理 |

---

## 1. 通用安全检查

### 输入验证

- [ ] 🔴 所有用户输入是否经过验证和清洗
- [ ] 🔴 SQL 查询是否使用参数化查询（非字符串拼接）
- [ ] 🔴 文件上传是否校验类型、大小、内容
- [ ] 🟠 数字参数是否校验范围（防止整数溢出）
- [ ] 🟠 字符串参数是否限制长度
- [ ] 🟠 数组/列表参数是否限制大小
- [ ] 🟡 是否对 JSON 解析做异常处理

### 认证与授权

- [ ] 🔴 敏感接口是否都要求认证
- [ ] 🔴 是否存在越权访问（水平越权：A 用户访问 B 的数据）
- [ ] 🔴 是否存在垂直越权（普通用户访问管理员接口）
- [ ] 🔴 Token/Session 是否有过期机制
- [ ] 🟠 密码是否使用 bcrypt/argon2 等安全哈希（非 MD5/SHA1）
- [ ] 🟠 登录失败是否有频率限制
- [ ] 🟠 敏感操作（修改密码、绑定手机）是否需要二次验证
- [ ] 🟡 JWT Token 是否设置合理的过期时间

### 敏感数据

- [ ] 🔴 密码、密钥、Token 是否明文存储在代码或配置中
- [ ] 🔴 日志中是否输出了敏感信息
- [ ] 🔴 API 响应是否返回了不必要的敏感字段
- [ ] 🟠 数据库连接串是否使用环境变量而非硬编码
- [ ] 🟠 加密算法是否使用现代标准（AES-256, RSA-2048+）
- [ ] 🟡 是否有数据脱敏策略（手机号、身份证号）

---

## 2. Web 应用安全

### XSS（跨站脚本）

- [ ] 🔴 用户输入内容在页面渲染前是否转义
- [ ] 🔴 是否禁止使用 `dangerouslySetInnerHTML` / `v-html`（除非内容来源可信并已清洗）
- [ ] 🟠 Content-Security-Policy (CSP) 是否配置
- [ ] 🟠 Cookie 是否设置 `HttpOnly` 标志

### CSRF（跨站请求伪造）

- [ ] 🔴 状态变更请求是否有 CSRF Token
- [ ] 🟠 Cookie 是否设置 `SameSite` 属性
- [ ] 🟡 关键操作是否验证 `Referer` / `Origin` 头

### 注入攻击

- [ ] 🔴 SQL 注入：是否 100% 使用参数化查询
- [ ] 🔴 命令注入：是否避免使用 `eval()`、`exec()`、`child_process.exec()`
- [ ] 🟠 LDAP/XML/NoSQL 注入：是否对特殊字符转义
- [ ] 🟠 路径穿越：文件操作是否校验路径，防止 `../../etc/passwd`

### HTTP 安全头

- [ ] 🟠 `Strict-Transport-Security` (HSTS)
- [ ] 🟠 `X-Content-Type-Options: nosniff`
- [ ] 🟠 `X-Frame-Options: DENY` 或 `SAMEORIGIN`
- [ ] 🟡 `Referrer-Policy: strict-origin-when-cross-origin`

---

## 3. API 安全

- [ ] 🔴 接口是否有认证保护（不该公开的接口不能匿名访问）
- [ ] 🔴 批量操作接口是否有数量限制
- [ ] 🔴 文件下载接口是否校验权限（防止通过 URL 猜测下载他人文件）
- [ ] 🟠 是否配置 CORS 白名单（非 `*`）
- [ ] 🟠 是否有请求大小限制（防止 DoS）
- [ ] 🟠 是否有限流策略
- [ ] 🟠 GraphQL：是否限制查询深度和复杂度
- [ ] 🟡 是否有请求日志审计
- [ ] 🟡 错误响应是否隐藏了内部实现细节

---

## 4. 数据库安全

- [ ] 🔴 数据库账号是否使用最小权限（应用账号不应有 DROP/GRANT 权限）
- [ ] 🔴 数据库是否禁止远程 root 登录
- [ ] 🟠 敏感字段（手机号、身份证）是否加密存储
- [ ] 🟠 是否有定期备份和恢复测试
- [ ] 🟡 慢查询是否有监控和告警

---

## 5. 依赖与环境安全

- [ ] 🔴 是否有已知漏洞的依赖（`npm audit` / `pip audit` / `snyk`）
- [ ] 🔴 `.env`、私钥文件是否在 `.gitignore` 中
- [ ] 🟠 依赖是否锁版本（`package-lock.json` / `poetry.lock`）
- [ ] 🟠 Docker 镜像是否使用非 root 用户运行
- [ ] 🟠 生产环境是否关闭调试模式
- [ ] 🟡 是否有依赖更新策略（定期检查安全更新）

---

## 6. 智能合约安全（Solidity）

### 高危漏洞

- [ ] 🔴 **重入攻击** — 外部调用前是否已更新状态（CEI 模式），是否使用 ReentrancyGuard
- [ ] 🔴 **整数溢出** — Solidity 0.8+ 自动检查，低版本需用 SafeMath
- [ ] 🔴 **未授权访问** — 关键函数是否有 `onlyOwner` / 角色控制
- [ ] 🔴 **签名重放** — 是否使用 nonce 防重放，签名是否包含 chainId
- [ ] 🔴 **闪电贷攻击** — 价格预言机是否使用 TWAP 而非即时价格

### 中危漏洞

- [ ] 🟠 **Owner 权限过大** — 是否使用 Ownable2Step（防误转）、多签、时间锁
- [ ] 🟠 **前端运行（Front-running）** — 敏感操作是否有 commit-reveal 方案
- [ ] 🟠 **拒绝服务** — 循环中是否可能 gas 耗尽，外部调用失败是否阻塞主流程
- [ ] 🟠 **ERC20 approve 竞争条件** — 是否使用 `increaseAllowance` 替代
- [ ] 🟠 **ETH 发送** — `transfer()` 和 `send()` 有 2300 gas 限制，推荐 `call{value:}`

### 最佳实践

- [ ] 🟡 是否使用最新稳定版 OpenZeppelin 合约
- [ ] 🟡 合约是否可暂停（Pausable）用于应急
- [ ] 🟡 是否有事件（Event）记录关键状态变更
- [ ] 🟡 构造函数参数是否有合理性校验
- [ ] 🔵 Gas 优化：状态变量读写次数、calldata vs memory、打包存储

---

## 7. 审计报告模板

```markdown
# 安全审计报告

## 基本信息
- 项目名称：
- 审计范围：
- 审计日期：
- 代码版本/Commit：

## 发现摘要
| 等级 | 数量 |
|------|------|
| 🔴 严重 | X |
| 🟠 警告 | X |
| 🟡 建议 | X |
| 🔵 优化 | X |

## 详细发现

### [S-01] 🔴 {漏洞标题}
- **位置**：`file.ts:L42`
- **描述**：...
- **影响**：...
- **修复建议**：
  ```code
  // 修复后的代码
  ```

### [W-01] 🟠 {问题标题}
...
```
